#!/bin/sh

# hardcoded in gvisor-tap-vsock
VPNKIT_GATEWAY_IP="192.168.127.1"
VPNKIT_HOST_IP="192.168.127.254"

# overrideable with env
GVPROXY_PATH=${GVPROXY_PATH:-/app/wsl-gvproxy.exe}
DNS_IP=${DNS_IP:-192.168.127.1}
TAP_NAME=${TAP_NAME:-wsltap}
CHECK_HOST=${CHECK_HOST:-example.com}
CHECK_DNS=${CHECK_DNS:-1.1.1.1}

# WSL2 default values
WSL2_TAP_NAME="eth0"
WSL2_GATEWAY_IP="$(cat /etc/resolv.conf | awk '/^nameserver/ {print $2}')"

# script vars
VM_PID=

set -x

run () {
    echo "starting gvproxy at $GVPROXY_PATH..."
    wsl-vm \
        -url="stdio:$GVPROXY_PATH?listen-stdio=accept" \
        -iface="$TAP_NAME" \
        -stop-if-exist="$TAP_NAME" &
    VM_PID=$!
    echo "started gvproxy"
}

tap_wait () {
    echo "waiting for dhcp..."
    c=1
    d=0
    while [ "$c" -eq 1 ] && [ "$d" -eq 0 ]; do
        sleep 0.1
        ip route show default dev $TAP_NAME | grep $TAP_NAME
        c=$?
        kill -0 $VM_PID
        d=$?
    done
    if [ "$d" -eq 1 ]; then
        echo "wsl-vm exited"
        exit 1
    fi
    echo "dhcp completed"
}

ipconfig () {
    echo "removing WSL 2 ip route..."
    ip route delete default dev $WSL2_TAP_NAME
    echo "removed WSL 2 ip route"

    echo "adding rules to iptables..."
    iptables -t nat -A PREROUTING -d $WSL2_GATEWAY_IP/32 -p udp -m udp --dport 53 -j DNAT --to-destination $DNS_IP:53
    iptables -t nat -A PREROUTING -d $WSL2_GATEWAY_IP/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination $DNS_IP:53
    iptables -t nat -A PREROUTING -d $WSL2_GATEWAY_IP/32 -j DNAT --to-destination $VPNKIT_HOST_IP
    iptables -t nat -A OUTPUT -d $WSL2_GATEWAY_IP/32 -p udp -m udp --dport 53 -j DNAT --to-destination $DNS_IP:53
    iptables -t nat -A OUTPUT -d $WSL2_GATEWAY_IP/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination $DNS_IP:53
    iptables -t nat -A OUTPUT -d $WSL2_GATEWAY_IP/32 -j DNAT --to-destination $VPNKIT_HOST_IP
    iptables -t nat -A POSTROUTING -o $TAP_NAME -j MASQUERADE
    echo "iptables done"
}

check_ping () {
    ping -$1 -c 1 $3 >/dev/null && \
        echo "check: ✔️ ping success to IPv$1 $2 ($3)" || \
        echo "check: $([ $1 = '6' ] && echo '➖' || echo '❌') ping fail to IPv$1 $2 ($3)"
}

check_dns () {
    TYPE=$([ "$1" = "4" ] && echo 'A' || echo 'AAAA')
    nslookup -type=$TYPE $2 $3 >/dev/null && \
        echo "check: ✔️ nslookup success for $2 $TYPE using $3" || \
        echo "check: ❌ nslookup fail for $2 $TYPE using $3"
}

check_https () {
    wget --spider -q $1 && \
        echo "check: ✔️ wget success for $1" || \
        echo "check: ❌ wget fail for $1"
}

check () {
    check_ping 4 'WSL 2 gateway / Windows host' $WSL2_GATEWAY_IP
    check_ping 4 'Windows host' $VPNKIT_HOST_IP
    check_ping 4 'gateway' $VPNKIT_GATEWAY_IP
    check_dns 4 $CHECK_HOST $DNS_IP
    check_dns 4 $CHECK_HOST $VPNKIT_GATEWAY_IP
    check_dns 4 $CHECK_HOST $WSL2_GATEWAY_IP
    check_dns 4 $CHECK_HOST $CHECK_DNS
    check_ping 4 'external host' $CHECK_HOST
    check_dns 6 $CHECK_HOST $DNS_IP
    check_dns 6 $CHECK_HOST $VPNKIT_GATEWAY_IP
    check_dns 6 $CHECK_HOST $WSL2_GATEWAY_IP
    check_dns 6 $CHECK_HOST $CHECK_DNS
    check_ping 6 'external host' $CHECK_HOST
    check_https "https://$CHECK_HOST"
}

cleanup () {
    echo "cleaning up iptables..."
    iptables -t nat -S | grep $VPNKIT_GATEWAY_IP | cut -d " " -f 2- | tr '\n' '\0' | xargs -0 -r -n 1 sh -c 'iptables -t nat -D $1' argv0
    iptables -t nat -S | grep $VPNKIT_HOST_IP | cut -d " " -f 2- | tr '\n' '\0' | xargs -0 -r -n 1 sh -c 'iptables -t nat -D $1' argv0
    iptables -t nat -S | grep $TAP_NAME | cut -d " " -f 2- | tr '\n' '\0' | xargs -0 -r -n 1 sh -c 'iptables -t nat -D $1' argv0
    iptables -t nat -S | grep $DNS_IP | cut -d " " -f 2- | tr '\n' '\0' | xargs -0 -r -n 1 sh -c 'iptables -t nat -D $1' argv0
    echo "iptables cleanup done"

    echo "restoring WSL 2 ip route..."
    ip route add default via $WSL2_GATEWAY_IP dev $WSL2_TAP_NAME proto kernel || :
    echo "restored WSL 2 ip route"
}

close () {
    cleanup
    echo "stopped wsl-vpnkit"
    kill 0
}

if [ ${EUID:-$(id -u)} -ne 0 ]; then
    echo "Please run this script as root"
    exit 1
fi

cleanup
run
tap_wait
ipconfig
check
trap close exit
trap exit int term
wait
